DROP VIEW IF EXISTS dw.hvm_emr_medctn;
CREATE VIEW dw.hvm_emr_medctn (
        row_id,
        hv_medctn_id,
        crt_dt,
        mdl_vrsn_num,
        data_set_nm,
        src_vrsn_id,
        hvm_vdr_id,
        hvm_vdr_feed_id,
        vdr_org_id,
        vdr_medctn_ord_id,
        vdr_medctn_ord_id_qual,
        vdr_medctn_admin_id,
        vdr_medctn_admin_id_qual,
        hvid,
        ptnt_birth_yr,
        ptnt_age_num,
        ptnt_lvg_flg,
        ptnt_dth_dt,
        ptnt_gender_cd,
        ptnt_state_cd,
        ptnt_zip3_cd,
        hv_enc_id,
        enc_dt,
        medctn_ord_dt,
        medctn_admin_dt,
        medctn_rndrg_fclty_taxnmy_id,
        medctn_rndrg_fclty_speclty_id,
        medctn_rndrg_fclty_state_cd,
        medctn_rndrg_fclty_zip_cd,
        medctn_ordg_prov_taxnmy_id,
        medctn_ordg_prov_speclty_id,
        medctn_ordg_prov_state_cd,
        medctn_ordg_prov_zip_cd,
        medctn_adminrg_fclty_taxnmy_id,
        medctn_adminrg_fclty_speclty_id,
        medctn_adminrg_fclty_state_cd,
        medctn_adminrg_fclty_zip_cd,
        rx_num,
        medctn_start_dt,
        medctn_end_dt,
        medctn_diag_cd,
        medctn_diag_cd_qual,
        medctn_ndc,
        medctn_lblr_cd,
        medctn_drug_and_strth_cd,
        medctn_pkg_cd,
        medctn_hicl_thrptc_cls_cd,
        medctn_hicl_cd,
        medctn_gcn_cd,
        medctn_rxnorm_cd,
        medctn_snomed_cd,
        medctn_genc_ok_flg,
        medctn_brd_nm,
        medctn_genc_nm,
        medctn_rx_flg,
        medctn_rx_qty,
        medctn_dly_qty,
        medctn_dispd_qty,
        medctn_days_supply_qty,
        medctn_admin_unt_qty,
        medctn_admin_freq_qty,
        medctn_admin_sched_cd,
        medctn_admin_sched_qty,
        medctn_admin_sig_cd,
        medctn_admin_sig_txt,
        medctn_admin_form_nm,
        medctn_specl_pkgg_cd,
        medctn_strth_txt,
        medctn_strth_txt_qual,
        medctn_dose_txt,
        medctn_dose_txt_qual,
        medctn_admin_rte_txt,
        medctn_orig_rfll_qty,
        medctn_fll_num,
        medctn_remng_rfll_qty,
        medctn_last_rfll_dt,
        medctn_smpl_flg,
        medctn_elect_rx_flg,
        medctn_verfd_flg,
        medctn_prod_svc_id,
        medctn_prod_svc_id_qual,
        data_captr_dt,
        rec_stat_cd,
        part_hvm_vdr_feed_id,
        part_mth,
        prmy_src_tbl_nm
        ) AS SELECT
    row_id,
    hv_medctn_id,
    crt_dt,
    mdl_vrsn_num,
    data_set_nm,
    src_vrsn_id,
    hvm_vdr_id,
    hvm_vdr_feed_id,
    vdr_org_id,
    vdr_medctn_ord_id,
    vdr_medctn_ord_id_qual,
    vdr_medctn_admin_id,
    vdr_medctn_admin_id_qual,
    hvid,
    ptnt_birth_yr,
    ptnt_age_num,
    ptnt_lvg_flg,
    ptnt_dth_dt,
    ptnt_gender_cd,
    ptnt_state_cd,
    ptnt_zip3_cd,
    hv_enc_id,
    enc_dt,
    medctn_ord_dt,
    medctn_admin_dt,
    COALESCE(medctn_rndrg_fclty_nucc_taxnmy_cd, medctn_rndrg_fclty_alt_taxnmy_id),
    COALESCE(medctn_rndrg_fclty_mdcr_speclty_cd, medctn_rndrg_fclty_alt_speclty_id),
    medctn_rndrg_fclty_state_cd,
    medctn_rndrg_fclty_zip_cd,
    COALESCE(medctn_ordg_prov_nucc_taxnmy_cd, medctn_ordg_prov_alt_taxnmy_id),
    COALESCE(medctn_ordg_prov_mdcr_speclty_cd, medctn_ordg_prov_alt_speclty_id),
    medctn_ordg_prov_state_cd,
    medctn_ordg_prov_zip_cd,
    COALESCE(medctn_adminrg_fclty_nucc_taxnmy_cd, medctn_adminrg_fclty_alt_taxnmy_id),
    COALESCE(medctn_adminrg_fclty_mdcr_speclty_cd, medctn_adminrg_fclty_alt_speclty_id),
    medctn_adminrg_fclty_state_cd,
    medctn_adminrg_fclty_zip_cd,
    rx_num,
    medctn_start_dt,
    medctn_end_dt,
    medctn_diag_cd,
    medctn_diag_cd_qual,
    CASE
      WHEN LENGTH(REGEXP_REPLACE(medctn_ndc, '[^0-9]', '')) >= 8
      THEN REGEXP_REPLACE(medctn_ndc, '[^0-9]', '')
    END AS medctn_ndc,
    medctn_lblr_cd,
    medctn_drug_and_strth_cd,
    medctn_pkg_cd,
    medctn_hicl_thrptc_cls_cd,
    medctn_hicl_cd,
    medctn_gcn_cd,
    medctn_rxnorm_cd,
    medctn_snomed_cd,
    medctn_genc_ok_flg,
    medctn_brd_nm,
    medctn_genc_nm,
    medctn_rx_flg,
    medctn_rx_qty,
    medctn_dly_qty,
    medctn_dispd_qty,
    medctn_days_supply_qty,
    medctn_admin_unt_qty,
    medctn_admin_freq_qty,
    medctn_admin_sched_cd,
    medctn_admin_sched_qty,
    medctn_admin_sig_cd,
    medctn_admin_sig_txt,
    medctn_admin_form_nm,
    medctn_specl_pkgg_cd,
    medctn_strth_txt,
    medctn_strth_txt_qual,
    medctn_dose_txt,
    medctn_dose_txt_qual,
    medctn_admin_rte_txt,
    medctn_orig_rfll_qty,
    medctn_fll_num,
    medctn_remng_rfll_qty,
    medctn_last_rfll_dt,
    medctn_smpl_flg,
    medctn_elect_rx_flg,
    medctn_verfd_flg,
    medctn_prod_svc_id,
    medctn_prod_svc_id_qual,
    data_captr_dt,
    rec_stat_cd,
    part_hvm_vdr_feed_id,
    part_mth,
    prmy_src_tbl_nm
FROM dw.emr_medctn
    ;
