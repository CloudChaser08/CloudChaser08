from pyspark.sql.types import StructType, StructField, StringType
from spark.helpers.source_table import SourceTable
import pyspark.sql.functions as F
import spark.helpers.postprocessor as postprocessor
import spark.helpers.records_loader as records_loader


def load(spark, runner, input_paths):
    for table, input_path in input_paths.items():
        if table == 'payload':
            source_table = TABLE_CONF[table]
            df = records_loader.load(runner, input_path, None,
                                     source_table.file_type, schema=source_table.schema,
                                     delimiter=source_table.separator)

            postprocessor.compose(
                postprocessor.trimmify,
                postprocessor.nullify
            )(df).createOrReplaceTempView(table)
        else:
            # Read in data as lines of text
            raw_df = spark.read.text(input_path)
            for t in set(TABLE_CONF.keys()) - set(['payload']):
                # Get the columns for each source table we expect
                cols = [x.name for x in TABLE_CONF[t].schema]
                # Filter based on the length of columns
                raw = raw_df.where(F.size(F.split(F.col('value'), '\|')) == F.lit(len(cols)))
                # Extract the line into a dataframe with one column for each element in the array
                split = raw.select(F.split(F.col('value'), '\|').alias('split')) \
                           .select(*[F.col('split')[i].alias(cols[i]) for i in range(len(cols))])
                # Trimmify and Nullify the data
                postprocessor.compose(
                    postprocessor.trimmify,
                    postprocessor.nullify
                )(split).createOrReplaceTempView(t)


TABLE_CONF = {
    'svc': SourceTable(
        'csv',
        separator='|',
        columns=[
            'service_payemnt_indicator',
            'batch_id',
            'claim_id',
            'sequence_number',
            'product_or_service_id_qualifier',
            'adjudicated_procedure_code',
            'adjudicated_procedure_modifier_1',
            'adjudicated_procedure_modifier_2',
            'adjudicated_procedure_modifer_3',
            'adjudicated_procedure_modifier_4',
            'procedure_code_description',
            'line_item_charge_amount',
            'line_item_provider_payment_amount',
            'nubc_revenue_code',
            'units_of_service_paid_count',
            'original_product_or_service_id_qualifier',
            'original_submitted_procedure_code',
            'original_submitted_procedure_modifier_s__1',
            'original_submitted_procedure_modifier_s__2',
            'original_submitted_procedure_modifier_s__3',
            'original_submitted_procedure_modifier_s__4',
            'original_units_of_service_count',
            'date___time_qualifier',
            'service_from_date',
            'service_to_date',
            'svc_line_adjustment_group_code_1',
            'svc_lineadj_group_1_reason_1',
            'svc_line_adj_group_1_amt_1',
            'svc_line_adj_group_1_qty_1',
            'svc_line_adj_group_1_reason_2',
            'svc_line_adj_group_1_amt_2',
            'svc_line_adj_group_1_qty_2',
            'svc_line_adj_group_1_reason_3',
            'svc_line_adj_group_1_amt_3',
            'svc_line_adj_group_1_qty_3',
            'svc_line_adj_group_1_reason_4',
            'svc_line_adj_group_1_amt_4',
            'svc_line_adj_group_1_qty_4',
            'svc_line_adj_group_1_reason_5',
            'svc_line_adj_group_1_amt_5',
            'svc_line_adj_group_1_qty_5',
            'svc_line_adj_group_1_reason_6',
            'svc_line_adj_group_1_amt_6',
            'svc_line_adj_group_1_qty_6',
            'svc_line_adjustment_group_code_2',
            'svc_lineadj_group_2_reason_1',
            'svc_line_adj_group_2_amt_1',
            'svc_line_adj_group_2_qty_1',
            'svc_line_adj_group_2_reason_2',
            'svc_line_adj_group_2_amt_2',
            'svc_line_adj_group_2_qty_2',
            'svc_line_adj_group_2_reason_3',
            'svc_line_adj_group_2_amt_3',
            'svc_line_adj_group_2_qty_3',
            'svc_line_adj_group_2_reason_4',
            'svc_line_adj_group_2_amt_4',
            'svc_line_adj_group_2_qty_4',
            'svc_line_adj_group_2_reason_5',
            'svc_line_adj_group_2_amt_5',
            'svc_line_adj_group_2_qty_5',
            'svc_line_adj_group_2_reason_6',
            'svc_line_adj_group_2_amt_6',
            'svc_line_adj_group_2_qty_6',
            'svc_line_adjustment_group_code_3',
            'svc_lineadj_group_3_reason_1',
            'svc_line_adj_group_3_amt_1',
            'svc_line_adj_group_3_qty_1',
            'svc_line_adj_group_3_reason_2',
            'svc_line_adj_group_3_amt_2',
            'svc_line_adj_group_3_qty_2',
            'svc_line_adj_group_3_reason_3',
            'svc_line_adj_group_3_amt_3',
            'svc_line_adj_group_3_qty_3',
            'svc_line_adj_group_3_reason_4',
            'svc_line_adj_group_3_amt_4',
            'svc_line_adj_group_3_qty_4',
            'svc_line_adj_group_3_reason_5',
            'svc_line_adj_group_3_amt_5',
            'svc_line_adj_group_3_qty_5',
            'svc_line_adj_group_3_reason_6',
            'svc_line_adj_group_3_amt_6',
            'svc_line_adj_group_3_qty_6',
            'svc_line_adjustment_group_code_4',
            'svc_lineadj_group_4_reason_1',
            'svc_line_adj_group_4_amt_1',
            'svc_line_adj_group_4_qty_1',
            'svc_line_adj_group_4_reason_2',
            'svc_line_adj_group_4_amt_2',
            'svc_line_adj_group_4_qty_2',
            'svc_line_adj_group_4_reason_3',
            'svc_line_adj_group_4_amt_3',
            'svc_line_adj_group_4_qty_3',
            'svc_line_adj_group_4_reason_4',
            'svc_line_adj_group_4_amt_4',
            'svc_line_adj_group_4_qty_4',
            'svc_line_adj_group_4_reason_5',
            'svc_line_adj_group_4_amt_5',
            'svc_line_adj_group_4_qty_5',
            'svc_line_adj_group_4_reason_6',
            'svc_line_adj_group_4_amt_6',
            'svc_line_adj_group_4_qty_6',
            'svc_line_adjustment_group_code_5',
            'svc_lineadj_group_5_reason_1',
            'svc_line_adj_group_5_amt_1',
            'svc_line_adj_group_5_qty_1',
            'svc_line_adj_group_5_reason_2',
            'svc_line_adj_group_5_amt_2',
            'svc_line_adj_group_5_qty_2',
            'svc_line_adj_group_5_reason_3',
            'svc_line_adj_group_5_amt_3',
            'svc_line_adj_group_5_qty_3',
            'svc_line_adj_group_5_reason_4',
            'svc_line_adj_group_5_amt_4',
            'svc_line_adj_group_5_qty_4',
            'svc_line_adj_group_5_reason_5',
            'svc_line_adj_group_5_amt_5',
            'svc_line_adj_group_5_qty_5',
            'svc_line_adj_group_5_reason_6',
            'svc_line_adj_group_5_amt_6',
            'svc_line_adj_group_5_qty_6',
            'service_id_qualifier_1s',
            'ambulatory_patient_group_number',
            'service_id_qualifier_apg',
            'ambulatory_payment_classification',
            'service_id_qualifier_bb',
            'authorization_number',
            'service_id_qualifier_e9',
            'attachment_code',
            'service_id_qualifier_g1',
            'prior_authorization_number',
            'service_id_qualifier_g3',
            'predetermination_of_benefits_id_number',
            'service_id_qualifier_lu',
            'location_number',
            'service_id_qualifier_rb',
            'rate_code_number',
            'line_item_control_number',
            'rendering_provider_id_qual_1',
            'rendering_provider_id__1',
            'rendering_provider_id_qual_2',
            'rendering_provider_id_2',
            'rendering_provider_id_qual_3',
            'rendering_provider_id__3',
            'rendering_provider_id_qual_4',
            'rendering_provider_id__4',
            'rendering_provider_id_qual_5',
            'rendering_provider_id__5',
            'rendering_provider_id_qual_6',
            'rendering_provider_id__6',
            'rendering_provider_id_qual_7',
            'rendering_provider_id__7',
            'rendering_provider_id_qual_8',
            'rendering_provider_id__8',
            'rendering_provider_id_qual_9',
            'rendering_provider_id__9',
            'rendering_provider_id_qual_10',
            'rendering_provider_id_10',
            'healthcare_policy_id_qual_1',
            'healthcare_policy_id__1',
            'healthcare_policy_id_qual_2',
            'healthcare_policy_id__2',
            'healthcare_policy_id_qual_3',
            'healthcare_policy_id__3',
            'healthcare_policy_id_qual_4',
            'healthcare_policy_id__4',
            'healthcare_policy_id_qual_5',
            'healthcare_policy_id__5',
            'service_line_supplemental_amount_identifier__informational_',
            'supplemental_service_amount',
            'allowed_amount',
            'late_amount',
            'service_line_supplemental_quantity_identifier__informational__1',
            'estimated_non_covered',
            'service_line_supplemental_quantity_identifier__informational__2',
            'federal_medicare_or_medicaid_payment_mandate_category_1',
            'service_line_supplemental_quantity_identifier__informational__3',
            'federal_medicare_or_medicaid_payment_mandate_category_2',
            'service_line_supplemental_quantity_identifier__informational__4',
            'federal_medicare_or_medicaid_payment_mandate_category_3',
            'service_line_supplemental_quantity_identifier__informational__5',
            'federal_medicare_or_medicaid_payment_mandate_category_4',
            'service_line_supplemental_quantity_identifier__informational__6',
            'federal_medicare_or_medicaid_payment_mandate_category_5',
            'remark_qual_1',
            'remark_code_1',
            'remark_qual_2',
            'remark_code_2',
            'remark_qual_3',
            'remark_code_3',
            'remark_qual_4',
            'remark_code_4',
            'remark_qual_5',
            'remark_code_5'
        ]
    ),
    'ts3': SourceTable(
        'csv',
        separator='|',
        columns=[
            'provider_summary_information',
            'batch_id',
            'provider_identifier',
            'facility_type_code',
            'fiscal_period_date',
            'total_claim_count',
            'total_claim_charge_amount',
            'total_covered_charge_amt',
            'total_non_covered_charge_amt',
            'total_denied_charge_amt',
            'total_provider_payment_amt',
            'total_interest_amt',
            'total_contractual_adjustment_amt',
            'total_gramm_rudman_reduction_amt',
            'total_msp_payer_amt',
            'total_blood_deductible_amt',
            'total_non_lab_charge_amt',
            'total_coinsurance_amt',
            'total_hcpcs_reported_charge_amt',
            'total_hcpcs_payable_amt',
            'total_deductible_amt',
            'total_professional_component_amt',
            'total_msp_patient_liability_met_amt',
            'total_patient_reimbursement_amt',
            'total_pip_claim_count',
            'total_pip_adjustment_amt',
            'total_drg_amt',
            'total_federal_specific_amt',
            'total_hospital_specific_amt',
            'total_disproportionate_share_amt',
            'total_capital_amt',
            'total_indirect_medical_education_amt',
            'total_outlier_day_count',
            'total_day_outlier_amt',
            'total_cost_outlier_amt',
            'average_drg_length_of_stay',
            'total_discharge_count',
            'total_cost_report_day_count',
            'total_covered_day_count',
            'total_non_covered_day_count',
            'total_msp_pass_through_amt',
            'average_drg_weight',
            'total_pps_capital_fsp_drg_amt',
            'total_pps_capital_hsp_drg_amt',
            'total_pps_dsh_drg_amt'
        ]
    ),
    'hdr': SourceTable(
        'csv',
        separator='|',
        columns=[
            'header_indicator',
            'batch_id',
            'x12_version',
            'receiver_id_number_qualifier',
            'receiver_id',
            'version_code_qualifier',
            'adjudication_version_id_code',
            'process_date_qual',
            'process_date',
            'payer_entity_id_code',
            'payer_name',
            'payer_id_code_qualifier',
            'tspid',
            'payer_id',
            'payer_address_line_1',
            'payer_address_line_2',
            'payer_city_name',
            'payer_state_code',
            'payer_postal_zone_or_zip_code',
            'reference_identification_qualifier_1',
            'medicare_fiscal_intermediary_or_bcbs_number',
            'reference_identification_qualifier_2',
            'submitter_id_number',
            'reference_identification_qualifier_3',
            'heallth_industry_number_hin',
            'reference_identification_qualifier_4',
            'naic_code',
            'payer_contact_function_code',
            'primary_payer_phone',
            'payee_entity_id_code',
            'payee_name',
            'payee_id_code_qual',
            'payee_tax_id',
            'payee_npi',
            'payee_address_line_1',
            'payee_address_line_2',
            'payee_city_name',
            'payee_state_code',
            'payee_postal_zone_or_zip_code',
            'payee_country_code',
            'state_license_number',
            'national_association_of_boards_of_pharmacy_number',
            'payee_addtl_identification',
            'federal_taxpayer_s_id_number'
        ]
    ),
    'plb': SourceTable(
        'csv',
        separator='|',
        columns=[
            'provider_adjustments_indicator',
            'batch_id',
            'claim_id',
            'provider_identifier',
            'fiscal_period_date',
            'provider_adjustment_reason_code',
            'provider_adjustment_identifier',
            'provider_adjustment_amount'
        ]
    ),
    'clp': SourceTable(
        'csv',
        separator='|',
        columns=[
            'claim_payment_indicator',
            'batch_id',
            'patient_control_number',
            'claim_status_code',
            'total_claim_charge_amount',
            'claim_payment_amount',
            'patient_responsibility_amount',
            'claim_filing_indicator_code',
            'payer_claim_control_number',
            'facility_type_code',
            'claim_frequency_code',
            'drg_code',
            'drg_weight',
            'discharge_fraction',
            'rendering_entity_id_code',
            'entity_type_qualifier_1',
            'rendering_provider_last_or_organization_name',
            'rendering_provider_first_name',
            'rendering_provider_middle_name',
            'rendering_provider_name_suffix',
            'identification_code_qualifier_1',
            'rendering_provider_identifier',
            'rendering_provider_npi',
            'cob_entity_id_code',
            'cob_entity_type_qual',
            'coordination_of_benefits_carrier_name',
            'identification_code_qualifier_2',
            'coordination_of_benefits_carrier_identifier',
            'entity_id_code',
            'entity_type_qualifier_2',
            'corrected_priority_payer_name',
            'identification_code_qualifier_3',
            'corrected_priority_payer_identification_number',
            'covered_days_or_visits_count',
            'pps_operaqting_outlier_amt',
            'lifetime_psychiatric_days_count',
            'claim_drg_amt',
            'remark_code',
            'claim_disproportionate_share_amt',
            'claim_msp_pass_through_amt',
            'claim_pps_capital_amt',
            'pps__capital_fsp_drg_amt',
            'pps___capital_hsp_drg_amt',
            'pps__capital_dsh_drg_amt',
            'old_capital_amt',
            'pps__capital_ime_amt',
            'pps___operating_hospital_specific_drg_amt',
            'cost_report_day_count',
            'pps___operating_federal_specific_drg_amt',
            'claim_pps_capital_outlier_amt',
            'claim_indirect_teaching_amt',
            'nonpayable_professional_component_amt',
            'remark_code_1',
            'remark_code_2',
            'remark_code_3',
            'remark_code_4',
            'pps___capital_exception_amt',
            'reimbursement_rate',
            'claim_hcpcs_payable_amount',
            'remark_code_5',
            'remark_code_6',
            'remark_code_7',
            'remark_code_8',
            'remark_code_9',
            'claim_esrd_payment_amount',
            'nonpayable_professional_component_amount',
            'repriced_claim_ref_num_qual',
            'repriced_claim_reference_number',
            'adjusted_repriced_claim_ref_num_qual',
            'adjusted_repriced_claim_reference_number',
            'auth_number_qual',
            'authorization_number',
            'class_of_contract_qual',
            'class_of_contract_code',
            'orig_ref_num_qual',
            'original_reference_number',
            'prior_auth_num_qual',
            'prior_authorization_number',
            'predetermination_of_benefits_id_num_qual',
            'predetermination_of_benefits_identification_number',
            'reference_identification_qualifier_1',
            'blue_cross_provider_number',
            'reference_identification_qualifier_2',
            'blue_shield_provider_number',
            'reference_identification_qualifier_3',
            'medicare_provider_number',
            'reference_identification_qualifier_4',
            'medicaid_provider_number',
            'reference_identification_qualifier_5',
            'provider_upin',
            'reference_identification_qualifier_6',
            'champus_id_number',
            'reference_identification_qualifier_7',
            'national_association_boards_pharmacy_number',
            'reference_identification_qualifier_8',
            'provider_commerical_number',
            'reference_identification_qualifier_9',
            'state_license_number',
            'reference_identification_qualifier_10',
            'facility_id_number',
            'reference_identification_qualifier_11',
            'location_number',
            'date___time_qualifier_1',
            'claim_statement_period_start',
            'date___time_qualifier_2',
            'claim_statement_period_end',
            'date___time_qualifier_3',
            'coverage_expiration_date',
            'date___time_qualifier_4',
            'claim_received_date',
            'claim_contact_function_code',
            'claim_contact_communications_number',
            'claim_supplemental_information_amount_identifier__informational_1',
            'total_covered_charges',
            'claim_supplemental_information_amount_identifier__informational_2',
            'prompt_pay_discount_amount',
            'claim_supplemental_information_amount_identifier__informational_3',
            'per_day_limit',
            'claim_supplemental_information_amount_identifier__informational_4',
            'patient_amount_paid',
            'claim_supplemental_information_amount_identifier__informational_5',
            'interest',
            'claim_supplemental_information_amount_identifier__informational_6',
            'negative_ledger_balance__medicare_pt_a___pt_b_only_',
            'claim_supplemental_information_amount_identifier__informational_7',
            'tax',
            'claim_supplemental_information_amount_identifier__informational_8',
            'total_claim_before_taxes',
            'claim_supplemental_information_amount_identifier__informational_9',
            'federal_medicare_or_medicaid_payment_mandate_category_1',
            'claim_supplemental_information_amount_identifier__informational_10',
            'federal_medicare_or_medicaid_payment_mandate_category_2',
            'claim_supplemental_information_amount_identifier__informational_11',
            'federal_medicare_or_medicaid_payment_mandate_category_3',
            'claim_supplemental_information_amount_identifier__informational_12',
            'federal_medicare_or_medicaid_payment_mandate_category_4',
            'claim_supplemental_information_amount_identifier__informational_13',
            'federal_medicare_or_medicaid_payment_mandate_category_5',
            'claim_supplemental_information_amount_identifier__informational_14',
            'mutually_defined__medicare_pt_a_operational_cost_or_day_outlier_amt',
            'claim_supplemental_information_quantity_identifier__informational_15',
            'covered___actual',
            'claim_supplemental_information_quantity_identifier__informational_16',
            'co_insured_actual',
            'claim_supplemental_information_quantity_identifier__informational_17',
            'actual_lifetime_reserve',
            'claim_supplemental_information_quantity_identifier__informational_18',
            'estimated_lifetime_reserve',
            'claim_supplemental_information_quantity_identifier__informational_19',
            'non_covered_days',
            'claim_supplemental_information_quantity_identifier__informational_20',
            'estimated_non_covered',
            'claim_supplemental_information_quantity_identifier__informational_21',
            'not_replaced_blood_units',
            'claim_supplemental_information_quantity_identifier__informational_22',
            'outlier_days',
            'claim_supplemental_information_quantity_identifier__informational_23',
            'prescription',
            'claim_supplemental_information_quantity_identifier__informational_24',
            'visits',
            'claim_supplemental_information_quantity_identifier__informational_25',
            'federal_medicare_or_medicaid_payment_mandate_category_6',
            'claim_supplemental_information_quantity_identifier__informational_26',
            'federal_medicare_or_medicaid_payment_mandate_category_7',
            'claim_supplemental_information_quantity_identifier__informational_27',
            'federal_medicare_or_medicaid_payment_mandate_category_8',
            'claim_supplemental_information_quantity_identifier__informational_28',
            'federal_medicare_or_medicaid_payment_mandate_category_9',
            'claim_supplemental_information_quantity_identifier__informational_29',
            'federal_medicare_or_medicaid_payment_mandate_category_10',
            'claim_adjustment_group_code_1',
            'adj_group_1_reason_1',
            'adj_group_1_amt_1',
            'adj_group_1_qty_1',
            'adj_group_1_reason_2',
            'adj_group_1_amt_2',
            'adj_group_1_qty_2',
            'adj_group_1_reason_3',
            'adj_group_1_amt_3',
            'adj_group_1_qty_3',
            'adj_group_1_reason_4',
            'adj_group_1_amt_4',
            'adj_group_1_qty_4',
            'adj_group_1_reason_5',
            'adj_group_1_amt_5',
            'adj_group_1_qty_5',
            'adj_group_1_reason_6',
            'adj_group_1_amt_6',
            'adj_group_1_qty_6',
            'claim_adjustment_group_code_2',
            'adj_group_2_reason_1',
            'adj_group_2_amt_1',
            'adj_group_2_qty_1',
            'adj_group_2_reason_2',
            'adj_group_2_amt_2',
            'adj_group_2_qty_2',
            'adj_group_2_reason_3',
            'adj_group_2_amt_3',
            'adj_group_2_qty_3',
            'adj_group_2_reason_4',
            'adj_group_2_amt_4',
            'adj_group_2_qty_4',
            'adj_group_2_reason_5',
            'adj_group_2_amt_5',
            'adj_group_2_qty_5',
            'adj_group_2_reason_6',
            'adj_group_2_amt_6',
            'adj_group_2_qty_6',
            'claim_adjustment_group_code_3',
            'adj_group_3_reason_1',
            'adj_group_3_amt_1',
            'adj_group_3_qty_1',
            'adj_group_3_reason_2',
            'adj_group_3_amt_2',
            'adj_group_3_qty_2',
            'adj_group_3_reason_3',
            'adj_group_3_amt_3',
            'adj_group_3_qty_3',
            'adj_group_3_reason_4',
            'adj_group_3_amt_4',
            'adj_group_3_qty_4',
            'adj_group_3_reason_5',
            'adj_group_3_amt_5',
            'adj_group_3_qty_5',
            'adj_group_3_reason_6',
            'adj_group_3_amt_6',
            'adj_group_3_qty_6',
            'claim_adjustment_group_code_4',
            'adj_group_4_reason_1',
            'adj_group_4_amt_1',
            'adj_group_4_qty_1',
            'adj_group_4_reason_2',
            'adj_group_4_amt_2',
            'adj_group_4_qty_2',
            'adj_group_4_reason_3',
            'adj_group_4_amt_3',
            'adj_group_4_qty_3',
            'adj_group_4_reason_4',
            'adj_group_4_amt_4',
            'adj_group_4_qty_4',
            'adj_group_4_reason_5',
            'adj_group_4_amt_5',
            'adj_group_4_qty_5',
            'adj_group_4_reason_6',
            'adj_group_4_amt_6',
            'adj_group_4_qty_6',
            'claim_adjustment_group_code_5',
            'adj_group_5_reason_1',
            'adj_group_5_amt_1',
            'adj_group_5_qty_1',
            'adj_group_5_reason_2',
            'adj_group_5_amt_2',
            'adj_group_5_qty_2',
            'adj_group_5_reason_3',
            'adj_group_5_amt_3',
            'adj_group_5_qty_3',
            'adj_group_5_reason_4',
            'adj_group_5amt_4',
            'adj_group_5_qty_4',
            'adj_group_5_reason_5',
            'adj_group_5_amt_5',
            'adj_group_5_qty_5',
            'adj_group_5_reason_6',
            'adj_group_5_amt_6',
            'adj_group_5_qty_6',
            'patient_last_name',
            'patient_first_name',
            'hvjoinkey'
        ]
    ),
    'payload': SourceTable(
        'json',
        schema=StructType([
            StructField('claimId', StringType(), True),
            StructField('PCN', StringType(), True),
            StructField('hvJoinKey', StringType(), True)
        ])
    )
}
