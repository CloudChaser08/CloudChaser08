SELECT
    data_set,
    pharmacy_ncpdp_number,
	pharmacy_zip_code,
	prescription_number_filler,
	date_written,
	date_filled,
	date_delivered_fulfilled,
	new_refill_counter,
	dispensed_ndc_number,
	prescribed_ndc_number,
	quantity_dispensed,
	days_supply,
	ingredient_cost,
	ingredient_cost_paid,
	dispensing_fee,
	dispensing_fee_paid,
	copay_coinsurance_amount,
	total_amount_paid_by_patient,
	reimbursed_amount,
	basis_of_ingredient_cost_submitted,
	basis_of_ingredient_cost_reimbursed,
	payment_type,
	indicator_for_coupon_type,
	coupon_face_value,
	coupon_id,
	plan_code,
	bank_identification_number,
	number_of_refills_authorized,
	dispensed_as_written,
	prescriber_last_name,
	prescriber_first_name,
	prescriber_dea_number,
	state_license_number_for_prescriber,
	prescriber_npi,
	prescriber_city,
	prescriber_state,
	prescriber_zip_code,
	pharmacy_npi,
	patient_birth_year,
	coordination_of_benefits_counter,
	patient_gender_code,
	patient_zip_code,
	origin_of_rx,
	level_of_service,
	claim_indicator,
	processor_control_number,
	compound_code,
	diagnosis_code,
	unit_of_measure,
	hvjoinkey
FROM
(
    SELECT
        split(data_set, '/')[size(split(data_set, '/')) - 1] as data_set,
        pharmacy_ncpdp_number,
		pharmacy_zip_code,
		prescription_number_filler,
		date_written,
		date_filled,
		date_delivered_fulfilled,
		new_refill_counter,
		dispensed_ndc_number,
		prescribed_ndc_number,
		quantity_dispensed,
		days_supply,
		ingredient_cost,
		ingredient_cost_paid,
		dispensing_fee,
		dispensing_fee_paid,
		copay_coinsurance_amount,
		total_amount_paid_by_patient,
		reimbursed_amount,
		basis_of_ingredient_cost_submitted,
		basis_of_ingredient_cost_reimbursed,
		payment_type,
		indicator_for_coupon_type,
		coupon_face_value,
		coupon_id,
		plan_code,
		bank_identification_number,
		number_of_refills_authorized,
		dispensed_as_written,
		prescriber_last_name,
		prescriber_first_name,
		prescriber_dea_number,
		state_license_number_for_prescriber,
		prescriber_npi,
		prescriber_city,
		prescriber_state,
		prescriber_zip_code,
		pharmacy_npi,
		patient_birth_year,
		coordination_of_benefits_counter,
		patient_gender_code,
		patient_zip_code,
		origin_of_rx,
		level_of_service,
		claim_indicator,
		processor_control_number,
		compound_code,
		diagnosis_code,
		unit_of_measure,
		hvjoinkey,
        ROW_NUMBER() OVER 
            (
                PARTITION BY 
                    pharmacy_ncpdp_number,
            		pharmacy_zip_code,
            		prescription_number_filler,
            		date_written,
            		date_filled,
            		date_delivered_fulfilled,
            		new_refill_counter,
            		dispensed_ndc_number,
            		prescribed_ndc_number,
            		quantity_dispensed,
            		days_supply,
            		ingredient_cost,
            		ingredient_cost_paid,
            		dispensing_fee,
            		dispensing_fee_paid,
            		copay_coinsurance_amount,
            		total_amount_paid_by_patient,
            		reimbursed_amount,
            		basis_of_ingredient_cost_submitted,
            		basis_of_ingredient_cost_reimbursed,
            		payment_type,
            		indicator_for_coupon_type,
            		coupon_face_value,
            		coupon_id,
            		plan_code,
            		bank_identification_number,
            		number_of_refills_authorized,
            		dispensed_as_written,
            		prescriber_last_name,
            		prescriber_first_name,
            		prescriber_dea_number,
            		state_license_number_for_prescriber,
            		prescriber_npi,
            		prescriber_city,
            		prescriber_state,
            		prescriber_zip_code,
            		pharmacy_npi,
            		patient_birth_year,
            		coordination_of_benefits_counter,
            		patient_gender_code,
            		patient_zip_code,
            		origin_of_rx,
            		level_of_service,
            		claim_indicator,
            		processor_control_number,
            		compound_code,
            		diagnosis_code,
            		unit_of_measure
            	/* Order by every column, to ensure a unique sort order. */
                ORDER BY 
                    pharmacy_ncpdp_number,
            		pharmacy_zip_code,
            		prescription_number_filler,
            		date_written,
            		date_filled,
            		date_delivered_fulfilled,
            		new_refill_counter,
            		dispensed_ndc_number,
            		prescribed_ndc_number,
            		quantity_dispensed,
            		days_supply,
            		ingredient_cost,
            		ingredient_cost_paid,
            		dispensing_fee,
            		dispensing_fee_paid,
            		copay_coinsurance_amount,
            		total_amount_paid_by_patient,
            		reimbursed_amount,
            		basis_of_ingredient_cost_submitted,
            		basis_of_ingredient_cost_reimbursed,
            		payment_type,
            		indicator_for_coupon_type,
            		coupon_face_value,
            		coupon_id,
            		plan_code,
            		bank_identification_number,
            		number_of_refills_authorized,
            		dispensed_as_written,
            		prescriber_last_name,
            		prescriber_first_name,
            		prescriber_dea_number,
            		state_license_number_for_prescriber,
            		prescriber_npi,
            		prescriber_city,
            		prescriber_state,
            		prescriber_zip_code,
            		pharmacy_npi,
            		patient_birth_year,
            		coordination_of_benefits_counter,
            		patient_gender_code,
            		patient_zip_code,
            		origin_of_rx,
            		level_of_service,
            		claim_indicator,
            		processor_control_number,
            		compound_code,
            		diagnosis_code,
            		unit_of_measure,
                        hvjoinkey
            ) AS row_num
     FROM pdx_transactions
)
WHERE row_num = 1
