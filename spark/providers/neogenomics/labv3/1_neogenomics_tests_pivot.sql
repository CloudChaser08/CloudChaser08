SELECT 
    header,
    source,
    SPLIT(input_file_name, '/')[SIZE(SPLIT(input_file_name, '/')) - 1]  AS input_file_name,
    patientid_hashed,
    accession_number_hashed,
    case_number_hashed,
    test_orderid_hashed,
    allowance,
    bill_type,
    POSEXPLODE(SPLIT(billing_icd_codes, ',')) AS (diagnosis_priority, billing_icd_codes),
    billing_price,
    biomarker_threshold,
    body_site,
    claim_id,
    copay,
    cpt_code,
    cpt_modifier_id,
    deductible,
    denials_reason_code,
    disease_stage,
    disease_threshold,
    insurance_company_id,
    insurance_company_name,
    level_of_service,
    methodology,
    methodology_threshold,
    ordering_practice_address_line_1,
    ordering_practice_city,
    ordering_practice_name,
    ordering_practice_state,
    ordering_practice_zip_code,
    ordering_provider_first_name,
    ordering_provider_last_name,
    ordering_provider_npi_number,
    panel_code,
    panel_name,
    patient_pay,
    payor_group_name,
    payor_paid_amount,
    performing_organization_address_line_1,
    performing_organization_city,
    performing_organization_name,
    performing_organization_state,
    performing_organization_zip_code,
    plan_pay,
    reason_for_refereal,
    receiving_organization_address_line_1,
    receiving_organization_city,
    receiving_organization_name,
    receiving_organization_state,
    receiving_organization_zip_code,
    referring_practice_address_line_1,
    referring_practice_city,
    referring_practice_name,
    referring_practice_state,
    referring_practice_zip_code,
    referring_provider_first_name,
    referring_provider_last_name,
    referring_provider_npi_number,
    billing_status,
    revenue_code,
    specimen_collection_date,
    specimen_prep_method,
    specimen_type,
    test_manufacturer,
    test_cancellation_date,
    test_code,
    test_created_date,
    test_kit,
    test_name,
    test_instrument,
    test_relevant_clinical_information,
    test_report_date,
    test_status,
    upstream_reflux,
    EXTRACT_DATE(REGEXP_EXTRACT(input_file_name, '(..../../..)/tests', 1), '%Y/%m/%d') AS vendor_file_date    
FROM tests
WHERE 0 <> LENGTH(TRIM(COALESCE(billing_icd_codes, '')))
UNION ALL
SELECT 
    header,
    source,
    SPLIT(input_file_name, '/')[SIZE(SPLIT(input_file_name, '/')) - 1]  AS input_file_name,
    patientid_hashed,
    accession_number_hashed,
    case_number_hashed,
    test_orderid_hashed,
    allowance,
    bill_type,
    NULL AS diagnosis_priority,
    NULL AS billing_icd_codes, 
    billing_price,
    biomarker_threshold,
    body_site,
    claim_id,
    copay,
    cpt_code,
    cpt_modifier_id,
    deductible,
    denials_reason_code,
    disease_stage,
    disease_threshold,
    insurance_company_id,
    insurance_company_name,
    level_of_service,
    methodology,
    methodology_threshold,
    ordering_practice_address_line_1,
    ordering_practice_city,
    ordering_practice_name,
    ordering_practice_state,
    ordering_practice_zip_code,
    ordering_provider_first_name,
    ordering_provider_last_name,
    ordering_provider_npi_number,
    panel_code,
    panel_name,
    patient_pay,
    payor_group_name,
    payor_paid_amount,
    performing_organization_address_line_1,
    performing_organization_city,
    performing_organization_name,
    performing_organization_state,
    performing_organization_zip_code,
    plan_pay,
    reason_for_refereal,
    receiving_organization_address_line_1,
    receiving_organization_city,
    receiving_organization_name,
    receiving_organization_state,
    receiving_organization_zip_code,
    referring_practice_address_line_1,
    referring_practice_city,
    referring_practice_name,
    referring_practice_state,
    referring_practice_zip_code,
    referring_provider_first_name,
    referring_provider_last_name,
    referring_provider_npi_number,
    billing_status,
    revenue_code,
    specimen_collection_date,
    specimen_prep_method,
    specimen_type,
    test_manufacturer,
    test_cancellation_date,
    test_code,
    test_created_date,
    test_kit,
    test_name,
    test_instrument,
    test_relevant_clinical_information,
    test_report_date,
    test_status,
    upstream_reflux,
    EXTRACT_DATE(REGEXP_EXTRACT(input_file_name, '(..../../..)/tests', 1), '%Y/%m/%d') AS vendor_file_date    
FROM tests
WHERE 0 = LENGTH(TRIM(COALESCE(billing_icd_codes, '')))
